# InnoDB 스토리지 엔진 아키텍처

<p align="center">
  <img src="https://user-images.githubusercontent.com/76584547/165796961-8d9664de-8d05-4db2-b15f-a6d1f14f4b73.png">
</p>

+ InnoDB는 MySQL에서 사용할 수 있는 스토리지 엔진 중 거의 유일하게 `레코드 기반의 잠금`을 제공하며
+ 이 때문에 `높은 동시성 처리`가 가능하고 안정적이며 성능이 뛰어나다

## 클러스터링 인덱스
### InnoDB
+ InnoDB의 모든 테이블은 기본적으로 프라이머리 키를 기준으로 클러스터링되어 저장
+ 즉, `프라이머리 키 값의 순서대로 디스크에 저장`된다는 뜻
+ 모든 `세컨더리 인덱스는 레코드의 주소 대신 프라이머리 키의 값을 논리적인 주소로 사용`
+ 프라이머리 키가 클러스터링 인덱스이기 때문에 프라이머리 키를 이용한 `레인지 스캔`은 상당히 빠르게 처리

### MyISAM
+ MyISAM 스토리지 엔진에서는 `클러스터링 키를 지원하지 않는다`
+ 그래서 MyISAM 스토리지 엔진에서는 프라이머리 키와 세컨더리 인덱스는 구조적으로 아무런 차이가 없다
+ 프라이머리 키는 그냥 유니크 제약을 가진 세컨더리 인덱스일 뿐이다.
+ `프라이머리 키를 포함한 모든 인덱스는 물리적인 레코드의 주소값을 가진다`

## 외래키 지원
+ 외래키에 대한 지원은 `InnoDB` 가능, `MyISAM`이나 `MEMORY`테이블 불가능
+ 변경시에 반드시 부모 테이블이나 자식 테이블에 데이터가 있는지 체크하는 작업이 필요하므로 `락이 여러 테이블로 전파`되며, `그로인한 데드락이 발생`

## MVCC (Multi Version Concurrency Control)
+ 레코드 레벨의 트랜잭션을 지원하는 DBMS가 제공하는 기능
+ MVCC의 가장 큰 목적은 `락을 사용하지 않는 일관된 읽기를 제공`하는 데 있다

> 예시) id - 12, name - "홍길동", area - "서울" 데이터 insert

<p align="center">
  <img src="https://user-images.githubusercontent.com/76584547/165799032-c0123f8f-599b-4855-83b0-aa4354441b04.png">
</p>

> 예시) id - 12인 row -> area - "경기"로 update 

<p align="center">
  <img src="https://user-images.githubusercontent.com/76584547/165799165-195be85d-ecba-48c0-afbd-9b1ca37edd41.png">
</p>

+ UPDATE 문장이 실행되면 `커밋 실행 여부와 관계 없이` InnoDB의 버퍼풀은 새로운 값인 `경기`로 업데이트 된다
+ `디스크의 데이터 파일`에는 체크포인트나 InnoDB의 Write 스레드에 의해 새로운 값으로 업데이트 돼있을 수도 있고 아닐 수도 있다 (`InnoDB가 ACID를 보장하기 때문에 일반적으로는 InnoDB 버퍼 풀과 데이터 파일은 동일한 상태`로 봐도 무방)
+ READ_COMMITTED나 그 이상의 격리 수준인 경우, 아직 커밋 되지 않았기 때문에 `언두 영역`에 있는 데이터를 반환하고 이 과정을 `MVCC`라고 한다.
+ 주의점!
  + 트랜잭션이 길어지면 언두에서 관리하는 예전 데이터가 삭제되지 못하고 오랫동안 관리돼야하며, 자연히 언두 영역이 저장되는 시스템 테이블 스페이스 공간이 늘어나는 상황 발생
+ `커밋이 된다고 언두 영역의 백업 데이터가 항상 바로 삭제되는 것이 아니다.`
+ `언두 영역을 필요로 하는 트랜잭션이 더는 없을 때 비로소 삭제`된다

## 잠금 없는 일관된 읽기 (Non-Locking Consistent Read)
+ 오랜시간 활성 상태인 트랜잭션으로 인해 MySQL 서버가 느려지거나 문제가 발생할 때가 가끔 있는데, 바로 이러한 일관된 읽기를 하기 위해 `언두 로그를 삭제하지 못하고` 계속 유지해야하기 때문에 발생
+ 때문에 `가능한 빨리 커밋하거나 롤백`해야한다

## 자동 데드락 감지
+

